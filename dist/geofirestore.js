!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.window=e.window||{})}(this,function(e){"use strict";var n=function(){function e(e){if(this._cancelCallback=e,"[object Function]"!==Object.prototype.toString.call(this._cancelCallback))throw new Error("callback must be a function")}return e.prototype.cancel=function(){void 0!==this._cancelCallback&&(this._cancelCallback(),this._cancelCallback=void 0)},e}(),h=10,f="0123456789bcdefghjkmnpqrstuvwxyz",u=40007860,y=110574,_=5,l=22*_,i=6378137,o=.00669447819799,a=1e-12;function d(e,t){var r;if(void 0===t&&(t=!1),"string"!=typeof e?r="key must be a string":0===e.length?r="key cannot be the empty string":755<1+h+e.length?r="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(r="key cannot contain any of the following characters: . # $ ] [ /"),void 0===r||t)return!r;throw new Error("Invalid GeoFire key '"+e+"': "+r)}function v(e,t){var r;if(void 0===t&&(t=!1),e)if(void 0===e.latitude)r="latitude must exist on GeoPoint";else if(void 0===e.longitude)r="longitude must exist on GeoPoint";else{var n=e.latitude,i=e.longitude;"number"!=typeof n||isNaN(n)?r="latitude must be a number":n<-90||90<n?r="latitude must be within the range [-90, 90]":"number"!=typeof i||isNaN(i)?r="longitude must be a number":(i<-180||180<i)&&(r="longitude must be within the range [-180, 180]")}else r="GeoPoint must exist";if(void 0===r||t)return!r;throw new Error("Invalid GeoFire location: "+r)}function p(e,t){var r;if(void 0===t&&(t=!1),"string"!=typeof e)r="geohash must be a string";else if(0===e.length)r="geohash cannot be the empty string";else for(var n=0,i=e;n<i.length;n++){var o=i[n];-1===f.indexOf(o)&&(r="geohash cannot contain '"+o+"'")}if(void 0===r||t)return!r;throw new Error("Invalid GeoFire geohash '"+e+"': "+r)}function s(e,t){var r;if(void 0===t&&(t=!1),r=p(e.g,!0)?null:"invalid geohash on object",r=v(e.l,!0)?r:"invalid location on object",e&&"d"in e&&"object"==typeof e.d||(r="no valid document found"),r&&!t)throw new Error("Invalid GeoFirestore object: "+r);return!r}function c(e,t){if(void 0===t&&(t=!1),"object"!=typeof e)throw new Error("query criteria must be an object");if(void 0===e.center&&void 0===e.radius)throw new Error("radius and/or center must be specified");if(t&&(void 0===e.center||void 0===e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var r=0,n=Object.keys(e);r<n.length;r++){var i=n[r];if("center"!==i&&"radius"!==i)throw new Error("Unexpected attribute '"+i+"' found in query criteria")}if(void 0!==e.center&&v(e.center),void 0!==e.radius){if("number"!=typeof e.radius||isNaN(e.radius))throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}}function g(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180}function m(e,t){if(void 0===t&&(t=h),v(e),void 0!==t){if("number"!=typeof t||isNaN(t))throw new Error("precision must be a number");if(t<=0)throw new Error("precision must be greater than 0");if(22<t)throw new Error("precision cannot be greater than 22");if(Math.round(t)!==t)throw new Error("precision must be an integer")}for(var r={min:-90,max:90},n={min:-180,max:180},i="",o=0,a=0,s=1;i.length<t;){var c=s?e.longitude:e.latitude,u=s?n:r,l=(u.min+u.max)/2;l<c?(o=1+(o<<1),u.min=l):(o=0+(o<<1),u.max=l),s=!s,a<4?a++:(a=0,i+=f[o],o=0)}return i}function b(e,t){var r=g(t),n=Math.cos(r)*i*Math.PI/180*(1/Math.sqrt(1-o*Math.sin(r)*Math.sin(r)));return n<a?0<e?360:0:Math.min(360,e/n)}function k(e,t){var r=b(e,t);return 1e-6<Math.abs(r)?Math.max(1,Math.log2(360/r)):1}function w(e){if(e<=180&&-180<=e)return e;var t=e+180;return 0<t?t%360-180:180- -t%360}function C(e,t){var r,n=t/y,i=Math.min(90,e.latitude+n),o=Math.max(-90,e.latitude-n),a=2*Math.floor((r=t,Math.min(Math.log2(u/2/r),l))),s=2*Math.floor(k(t,i))-1,c=2*Math.floor(k(t,o))-1;return Math.min(a,s,c,l)}function t(e,t){v(e);var r,n,i,o,a,s,c,u,l=Math.max(1,C(e,t)),h=Math.ceil(l/_),d=(r=e,i=(n=t)/y,o=Math.min(90,r.latitude+i),a=Math.max(-90,r.latitude-i),s=b(n,o),c=b(n,a),u=Math.max(s,c),[M(r.latitude,r.longitude),M(r.latitude,w(r.longitude-u)),M(r.latitude,w(r.longitude+u)),M(o,r.longitude),M(o,w(r.longitude-u)),M(o,w(r.longitude+u)),M(a,r.longitude),M(a,w(r.longitude-u)),M(a,w(r.longitude+u))]).map(function(e){return function(e,t){p(e);var r=Math.ceil(t/_);if(e.length<r)return[e,e+"~"];var n=(e=e.substring(0,r)).substring(0,e.length-1),i=f.indexOf(e.charAt(e.length-1)),o=t-n.length*_,a=_-o,s=i>>a<<a,c=s+(1<<a);return 31<c?[n+f[s],n+"~"]:[n+f[s],n+f[c]]}(m(e,h),l)});return d.filter(function(r,n){return!d.some(function(e,t){return t<n&&r[0]===e[0]&&r[1]===e[1]})})}function E(e,t,r){return v(e),p(t),{g:t,l:e,d:r}}function G(e){var t;return"string"!=typeof e.id&&null!==e.id||(t=e.id),t}function Q(e,t){var r,n;if(e&&"object"==typeof e?t&&t in e?n=t:"coordinates"in e?n="coordinates":r="no valid key exists":r="document not an object",n&&!v(e[n],!0)&&(r=n+" is not a valid GeoPoint"),r)throw new Error("Invalid GeoFirestore document: "+r);return n}function M(e,t){var r={latitude:e,longitude:t};return v(r),r}Math.log2=Math.log2||function(e){return Math.log(e)/Math.log(2)};var r=function(){function e(e,t){var r=this;if(this._collectionRef=e,this._callbacks={ready:[],key_entered:[],key_exited:[],key_moved:[],key_modified:[]},this._cancelled=!1,this._currentGeohashesQueried=new Map,this._locationsTracked=new Map,this._valueEventFired=!1,this._geohashCleanupScheduled=!1,"[object Object]"!==Object.prototype.toString.call(this._collectionRef))throw new Error("firebaseRef must be an instance of Firestore");this._cleanUpCurrentGeohashesQueriedInterval=setInterval(function(){!1===r._geohashCleanupScheduled&&r._cleanUpCurrentGeohashesQueried()},1e4),c(t,!0),this._center=t.center,this._radius=t.radius,this._listenForNewGeohashes()}return e.prototype.cancel=function(){var t=this;this._cancelled=!0,this._callbacks={ready:[],key_entered:[],key_exited:[],key_moved:[],key_modified:[]},Array.from(this._currentGeohashesQueried.keys()).forEach(function(e){t._cancelGeohashQuery(t._currentGeohashesQueried.get(e)),t._currentGeohashesQueried.delete(e)}),this._locationsTracked=new Map,clearInterval(this._cleanUpCurrentGeohashesQueriedInterval)},e.prototype.center=function(){return this._center},e.prototype.on=function(e,r){var t=this;if(-1===["ready","key_entered","key_exited","key_moved","key_modified"].indexOf(e))throw new Error("event type must be 'ready', 'key_entered', 'key_exited', 'key_moved', or 'key_modified'");if("function"!=typeof r)throw new Error("callback must be a function");return this._callbacks[e].push(r),"key_entered"===e&&this._locationsTracked.forEach(function(e,t){void 0!==e&&e.isInQuery&&r(t,e.document,e.distanceFromCenter)}),"ready"===e&&this._valueEventFired&&r(),new n(function(){t._callbacks[e].splice(t._callbacks[e].indexOf(r),1)})},e.prototype.radius=function(){return this._radius},e.prototype.updateCriteria=function(e){c(e),this._center=e.center||this._center,this._radius=e.radius||this._radius;for(var t=0,r=Array.from(this._locationsTracked.keys());t<r.length;t++){var n=r[t];if(!0===this._cancelled)break;var i=this._locationsTracked.get(n),o=i.isInQuery;i.distanceFromCenter=x.distance(i.location,this._center),i.isInQuery=i.distanceFromCenter<=this._radius,o&&!i.isInQuery?this._fireCallbacksForKey("key_exited",n,i.document,i.distanceFromCenter):!o&&i.isInQuery&&this._fireCallbacksForKey("key_entered",n,i.document,i.distanceFromCenter)}this._valueEventFired=!1,this._listenForNewGeohashes()},e.prototype._cancelGeohashQuery=function(e){e.childCallback(),e.valueCallback()},e.prototype._childAddedCallback=function(e){var t=e.exists?e.data():null,r=t&&s(t)?t.d:null,n=t&&v(t.l)?t.l:null;this._updateLocation(G(e),n,r)},e.prototype._childChangedCallback=function(e){var t=e.exists?e.data():null,r=t&&s(t)?t.d:null,n=t&&v(t.l)?t.l:null;this._updateLocation(G(e),n,r,!0)},e.prototype._childRemovedCallback=function(e){var o=this,a=G(e);this._locationsTracked.has(a)&&this._collectionRef.doc(a).get().then(function(e){var t=e.exists?e.data():null,r=t&&s(t)?t.d:null,n=t&&v(t.l)?t.l:null,i=null!==n?m(n):null;o._geohashInSomeQuery(i)||o._removeLocation(a,r)})},e.prototype._cleanUpCurrentGeohashesQueried=function(){var r=this,e=Array.from(this._currentGeohashesQueried.keys());e.forEach(function(e){var t=r._currentGeohashesQueried.get(e);!1===t.active&&(r._cancelGeohashQuery(t),r._currentGeohashesQueried.delete(e))}),(e=Array.from(this._locationsTracked.keys())).forEach(function(e){if(!r._geohashInSomeQuery(r._locationsTracked.get(e).geohash)){if(r._locationsTracked.get(e).isInQuery)throw new Error("Internal State error, trying to remove location that is still in query");r._locationsTracked.delete(e)}}),this._geohashCleanupScheduled=!1,null!==this._cleanUpCurrentGeohashesQueriedTimeout&&(clearTimeout(this._cleanUpCurrentGeohashesQueriedTimeout),this._cleanUpCurrentGeohashesQueriedTimeout=null)},e.prototype._fireCallbacksForKey=function(e,t,r,n){this._callbacks[e].forEach(function(e){null==r?e(t,null,null):e(t,r,n)})},e.prototype._fireReadyEventCallbacks=function(){this._callbacks.ready.forEach(function(e){e()})},e.prototype._geohashInSomeQuery=function(e){for(var t=0,r=Array.from(this._currentGeohashesQueried.keys());t<r.length;t++){var n=r[t];if(this._currentGeohashesQueried.has(n)){var i=this._stringToQuery(n);if(e>=i[0]&&e<=i[1])return!0}}return!1},e.prototype._geohashQueryReadyCallback=function(e){var t=this._outstandingGeohashReadyEvents.indexOf(e);-1<t&&this._outstandingGeohashReadyEvents.splice(t,1),this._valueEventFired=0===this._outstandingGeohashReadyEvents.length,this._valueEventFired&&this._fireReadyEventCallbacks()},e.prototype._listenForNewGeohashes=function(){var o=this,n=t(this._center,1e3*this._radius).map(this._queryToString);n=n.filter(function(e,t){return n.indexOf(e)===t}),this._currentGeohashesQueried.forEach(function(e,t){var r=n.indexOf(t);-1===r?e.active=!1:(e.active=!0,n.splice(r,1))}),!1===this._geohashCleanupScheduled&&25<this._currentGeohashesQueried.size&&(this._geohashCleanupScheduled=!0,this._cleanUpCurrentGeohashesQueriedTimeout=setTimeout(this._cleanUpCurrentGeohashesQueried,10)),this._outstandingGeohashReadyEvents=n.slice(),n.forEach(function(e){var t=o._stringToQuery(e),r=o._collectionRef.orderBy("g").startAt(t[0]).endAt(t[1]),n=r.onSnapshot(function(e){e.docChanges().forEach(function(e){"added"===e.type&&o._childAddedCallback(e.doc),"modified"===e.type&&o._childChangedCallback(e.doc),"removed"===e.type&&o._childRemovedCallback(e.doc)})}),i=r.onSnapshot(function(){i(),o._geohashQueryReadyCallback(e)});o._currentGeohashesQueried.set(e,{active:!0,childCallback:n,valueCallback:i})}),0===n.length&&this._geohashQueryReadyCallback()},e.prototype._queryToString=function(e){if(2!==e.length)throw new Error("Not a valid geohash query: "+e);return e[0]+":"+e[1]},e.prototype._removeLocation=function(e,t){var r=this._locationsTracked.get(e);if(this._locationsTracked.delete(e),void 0!==r&&r.isInQuery){var n=t?Q(t):null,i=n?t[n]:null,o=i?x.distance(i,this._center):null;this._fireCallbacksForKey("key_exited",e,t,o)}},e.prototype._stringToQuery=function(e){var t=e.split(":");if(2!==t.length)throw new Error("Invalid internal state! Not a valid geohash query: "+e);return t},e.prototype._updateLocation=function(e,t,r,n){var i,o;void 0===n&&(n=!1),v(t);var a=!!this._locationsTracked.has(e)&&this._locationsTracked.get(e).isInQuery,s=this._locationsTracked.has(e)?this._locationsTracked.get(e).location:null;o=(i=x.distance(t,this._center))<=this._radius,this._locationsTracked.set(e,{distanceFromCenter:i,document:r,geohash:m(t),isInQuery:o,location:t}),o&&!a?this._fireCallbacksForKey("key_entered",e,r,i):!o||null===s||t.latitude===s.latitude&&t.longitude===s.longitude?!o&&a?this._fireCallbacksForKey("key_exited",e,r,i):o&&n&&this._fireCallbacksForKey("key_modified",e,r,i):this._fireCallbacksForKey("key_moved",e,r,i)},e}(),x=function(){function e(e){if(this._collectionRef=e,"[object Object]"!==Object.prototype.toString.call(this._collectionRef))throw new Error("collectionRef must be an instance of a Firestore Collection")}return e.prototype.add=function(e,t){if("object"!=typeof e||Array.isArray(e))throw new Error("document must be an object");var r=e[Q(e,t)],n=m(r);return this._collectionRef.add(E(r,n,e))},e.prototype.get=function(e){return d(e),this._collectionRef.doc(e).get().then(function(e){return e.exists?function(e){if(s(e,!0))return e.d;throw new Error("Unexpected location object encountered: "+JSON.stringify(e))}(e.data()):null})},e.prototype.ref=function(){return this._collectionRef},e.prototype.remove=function(e){if(Array.isArray(e)){var t={};return e.forEach(function(e){t[e]=null}),this.set(t)}return this.set(e)},e.prototype.set=function(o,e,a){var s=this;if("string"==typeof o&&0!==o.length){if(d(o),e){var t=e[Q(e,a)],r=m(t);return this._collectionRef.doc(o).set(E(t,r,e))}return this._collectionRef.doc(o).delete()}if("object"!=typeof o)throw new Error("keyOrDocuments must be a string or a mapping of key - document pairs.");if(void 0!==e)throw new Error("The location argument should not be used if you pass an object to set().");var c=this._collectionRef.firestore.batch();return Object.keys(o).forEach(function(e){d(e);var t=s._collectionRef.doc(e),r=o[e];if(r){var n=r[Q(r,a)],i=m(n);c.set(t,E(n,i,r),{merge:!0})}else c.delete(t)}),c.commit()},e.prototype.query=function(e){return new r(this._collectionRef,e)},e.distance=function(e,t){v(e),v(t);var r=g(t.latitude-e.latitude),n=g(t.longitude-e.longitude),i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(g(e.latitude))*Math.cos(g(t.latitude))*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))},e}();e.GeoCallbackRegistration=n,e.GeoFirestore=x,e.GeoFirestoreQuery=r,Object.defineProperty(e,"__esModule",{value:!0})});
